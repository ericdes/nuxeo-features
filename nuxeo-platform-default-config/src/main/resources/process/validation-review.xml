<process-definition name="review_approbation">
  <swimlane name="initiator" />
  <start-state>
    <task swimlane='initiator' name="start" />
    <transition to='choose participants node' />
  </start-state>
  <task-node name="choose participants node">
    <task name="choose-participant" swimlane="initiator" />
    <transition to="condition on participants" />
  </task-node>
  <!-- add rights -->
  <decision name="condition on participants">
    <event type="node-enter">
      <script><![CDATA[executionContext.setVariable("previousActorId", executionContext.jbpmContext.actorId)]]></script>
    </event>
    <transition to="setup rights" />
    <transition condition="#{empty participants}" to="follow transition" />
  </decision>

  <node name="setup rights">
    <action
      class="org.nuxeo.ecm.platform.jbpm.core.helper.AddRightsActionHandler">
      <list>participants</list>
    </action>
    <transition to="validate node" />
  </node>

  <task-node name="validate node">
    <task name="validate">
      <controller
        class="org.nuxeo.ecm.platform.jbpm.core.node.VirtualTaskInstanceController" />
      <assignment pooled-actors="#{participants[0].actors}" />
    </task>
    <transition name="validate" to="condition on participants">
      <script>
        <variable name="participants" />
        <expression><![CDATA[!participants.isEmpty() && participants.remove(0) != null]]></expression>
      </script>
    </transition>
    <transition name="reject" to="validate after reject node" />
  </task-node>

  <task-node name="validate after reject node">
    <task name="validate-after-reject">
      <assignment actor-id="#{previousActorId}" />
    </task>
    <transition to="condition on participants">
      <script>
        <variable name="participants" />
        <expression><![CDATA[!participants.isEmpty() && participants.remove(0) != null]]></expression>
      </script>
    </transition>
  </task-node>

  <node name="follow transition">
    <action
      class="org.nuxeo.ecm.platform.jbpm.core.helper.LifecycleTransitionActionHandler" />
    <transition to="end" />
  </node>
  <end-state name="end">
    <event type="node-enter">
      <action
        class="org.nuxeo.ecm.platform.jbpm.core.helper.RemoveRightsActionHandler" />
    </event>
  </end-state>
</process-definition>
