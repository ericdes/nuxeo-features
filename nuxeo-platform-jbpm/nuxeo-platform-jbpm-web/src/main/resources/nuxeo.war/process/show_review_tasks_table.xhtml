<div xmlns:nxthemes="http://nuxeo.org/nxthemes"
  xmlns:ui="http://java.sun.com/jsf/facelets"
  xmlns:f="http://java.sun.com/jsf/core"
  xmlns:h="http://java.sun.com/jsf/html"
  xmlns:a4j="https://ajax4jsf.dev.java.net/ajax"
  xmlns:c="http://java.sun.com/jstl/core"
  xmlns:nxu="http://nuxeo.org/nxweb/util"
  xmlns:nxl="http://nuxeo.org/nxforms/layout">

<c:set var="virtualTasks" value="#{jbpmActions.currentVirtualTasks}" />
<nxu:methodResult name="tasks" value="#{jbpmActions.getCurrentTasks('validate', 'validate-after-reject')}">

<c:if test="#{not empty virtualTasks or not empty tasks}">

<div class="closedContent">

<h:form id="reviewTasksTable">

  <script type="text/javascript">
  function confirmDeleteTask() {
    return confirm("#{messages['label.review.confirmDeleteTask']}");
  }
  </script>

  <h3>
    <h:outputText
      value="#{messages['label.workflow.review.task.list']}" />
  </h3>

  <table class="dataOutput">
    <thead>
      <tr>
        <f:subview rendered="#{jbpmActions.canManageProcess}">
          <th class="iconColum"></th>
        </f:subview>
        <th>
          <h:outputText value="#{messages['label.workflow.task.validated']}" />
        </th>
        <th>
          <h:outputText
            value="#{messages['label.workflow.task.principal']}" />
        </th>
        <th>
          <h:outputText
            value="#{messages['label.workflow.task.directive']}" />
        </th>
        <th>
          <h:outputText
            value="#{messages['label.review.user.comment']}" />
        </th>
        <th>
          <h:outputText
            value="#{messages['label.workflow.task.startdate']}" />
        </th>
        <th>
          <h:outputText
            value="#{messages['label.workflow.task.enddate']}" />
        </th>
        <th>
          <h:outputText
            value="#{messages['label.workflow.task.duedate']}" />
        </th>
        <th></th>
        <th></th>
        <f:subview rendered="#{jbpmActions.canManageProcess}">
          <th class="iconColumn">
          </th>
        </f:subview>
      </tr>
    </thead>
    <tbody>
      <nxu:repeat var="task" value="#{tasks}">
        <tr>
          <f:subview rendered="#{jbpmActions.canManageProcess}">
            <td class="iconColumn">
            </td>
          </f:subview>
          <td class="iconColumn">
            <h:graphicImage value="/icons/review_pending.gif"
              rendered="#{empty task.create}" />
            <h:graphicImage value="/icons/review_current_level.gif"
              rendered="#{!empty task.create and empty task.end}" />
            <h:graphicImage value="/icons/review_accepted.png"
              rendered="#{!empty task.end and task.variables.validated}" />
            <h:graphicImage value="/icons/review_refused.png"
              rendered="#{!empty task.end and !task.variables.validated}" />
          </td>
          <td>
            <nxl:layout name="user_group_prefixed_suggestion" mode="view"
              value="#{jbpmHelper.getPooledActorIds(task)}" />
          </td>
          <td>
            <h:outputText value="#{messages[task.variables.directive]}" />
          </td>
          <td>
            <nxu:repeat name="comment" value="#{task.comments}">
              <nxu:methodResult name="userInfo" value="#{userSuggestionActions.getPrefixedUserInfo(comment.actorId)}">
                <f:subview rendered="#{info.type == 'USER_TYPE'}">
                  <h:outputText value="#{nxu:userDisplayName(userInfo.id, userInfo.entry.user.firstName, userInfo.entry.user.lastName)}" />
                </f:subview>
                <f:subview rendered="#{userInfo.type != 'USER_TYPE'}">
                  <h:outputText value="#{comment.actorId}" />
                </f:subview>
              </nxu:methodResult>
              <h:outputText value=": #{comment.message}" />
            </nxu:repeat>
          </td>
          <td>
            <h:outputText value="#{task.create}">
              <f:convertDateTime
                pattern="#{nxu:dateAndTimeFormater('medium')}"
                timeZone="#{timeZone}" />
            </h:outputText>
          </td>
          <td>
            <h:outputText value="#{task.end}">
              <f:convertDateTime
                pattern="#{nxu:dateAndTimeFormater('medium')}"
                timeZone="#{timeZone}" />
            </h:outputText>
          </td>
          <td>
            <h:outputText value="#{task.dueDate}">
              <f:convertDateTime
                pattern="#{nxu:dateAndTimeFormater('medium')}"
                timeZone="#{timeZone}" />
            </h:outputText>
          </td>
          <td>
            <f:subview rendered="#{jbpmActions.getCanEndTask(task)}">
              <h:commandLink value="#{messages['label.review.end.task']}"
                action="#{jbpmActions.validateTask(task, null)}" />
            </f:subview>
          </td>
          <td>
            <f:subview rendered="#{jbpmActions.getCanEndTask(task)}">
              <h:commandLink value="#{messages['label.review.reject.task']}"
                action="#{jbpmActions.rejectTask(task, 'reject')}" />
            </f:subview>
          </td>
          <f:subview rendered="#{jbpmActions.canManageProcess}">
            <td></td>
          </f:subview>                
        </tr>
      </nxu:repeat>
      <nxu:repeat var="virtualTask" value="#{virtualTasks}" index="index">
        <tr>
          <f:subview rendered="#{jbpmActions.canManageProcess}">
            <td class="iconColum">
              <h:commandLink action="#{jbpmActions.removeVirtualTask(index)}"
                onclick="return confirmDeleteTask();">
                <h:graphicImage value="/icons/action_delete.gif" />
              </h:commandLink>
            </td>
          </f:subview>      
          <td class="iconColumn">
            <h:graphicImage value="/icons/review_pending.gif" />
          </td>
          <td>
            <nxl:layout name="user_group_prefixed_suggestion" mode="view"
              value="#{virtualTask.actors}" />
          </td>
          <td>
            <h:outputText
              value="#{messages[virtualTask.directive]}" />
          </td>
          <td>
            <h:outputText value="#{virtualTask.comment}" />
          </td>
          <td>
          </td>
          <td>
          </td>
          <td>
            <h:outputText value="#{virtualTask.dueDate}">
              <f:convertDateTime
                pattern="#{nxu:dateAndTimeFormater('medium')}"
                timeZone="#{timeZone}" />
            </h:outputText>
          </td>
          <td>
          </td>
          <td>
          </td>
          <f:subview rendered="#{jbpmActions.canManageProcess}">
            <td class="iconColum">
              <h:commandLink action="#{jbpmActions.moveUpVirtualTask(index)}"
                rendered="#{index != 0}">
                <h:graphicImage value="/icons/arrow_up.gif" />
              </h:commandLink>
              <br />
              <h:commandLink action="#{jbpmActions.moveDownVirtualTask(index)}"
                rendered="#{index +1 != virtualTasks.size()}">
                <h:graphicImage value="/icons/arrow_down.gif" />
              </h:commandLink>
            </td>
          </f:subview>
        </tr>
      </nxu:repeat>
    </tbody>
  </table>
  
  <f:subview rendered="#{jbpmActions.canManageProcess and !jbpmActions.isProcessStarted('choose-participant')}">
    <div>
      <h:commandButton value="#{messages['label.workflow.start']}"
        action="#{jbpmActions.startProcess('choose-participant')}"
        styleClass="button" />
    </div>
  </f:subview>

</h:form>

</div>

</c:if>

</nxu:methodResult>

</div>